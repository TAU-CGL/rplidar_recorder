import reccalib
import numpy as np
import matplotlib.pyplot as plt

LAB_POLYGON = np.array([[0.0389390000000005,-0.6334060000000001],[-0.011060999999999765,-0.6834060000000002],[-0.06106099999999959,-0.6834060000000002],[-0.11106099999999985,-0.6834060000000002],[-0.16106099999999968,-0.733406],[-0.11106099999999985,-0.783406],[-0.11106099999999985,-0.8334060000000001],[-0.11106099999999985,-0.8834060000000001],[-0.11106099999999985,-0.9334060000000002],[-0.06106099999999959,-0.983406],[-0.06106099999999959,-1.033406],[-0.06106099999999959,-1.083406],[-0.011060999999999765,-1.1334060000000001],[0.0389390000000005,-1.1334060000000001],[0.08893900000000032,-1.083406],[0.13893900000000015,-1.083406],[0.1889390000000004,-1.083406],[0.23893900000000023,-1.083406],[0.2889390000000005,-1.083406],[0.3389390000000003,-1.083406],[0.38893900000000015,-1.083406],[0.38893900000000015,-1.1334060000000001],[0.38893900000000015,-1.1834060000000002],[0.38893900000000015,-1.233406],[0.3389390000000003,-1.2834060000000003],[0.2889390000000005,-1.333406],[0.23893900000000023,-1.333406],[0.1889390000000004,-1.333406],[0.13893900000000015,-1.333406],[0.08893900000000032,-1.333406],[0.0389390000000005,-1.333406],[-0.011060999999999765,-1.333406],[-0.06106099999999959,-1.3834060000000001],[-0.11106099999999985,-1.3834060000000001],[-0.16106099999999968,-1.3834060000000001],[-0.2110609999999995,-1.3834060000000001],[-0.26106099999999977,-1.3834060000000001],[-0.3110609999999996,-1.3834060000000001],[-0.36106099999999985,-1.3834060000000001],[-0.4110609999999997,-1.3834060000000001],[-0.4610609999999995,-1.3834060000000001],[-0.5110609999999998,-1.4334060000000002],[-0.5610609999999996,-1.4334060000000002],[-0.6110609999999999,-1.4334060000000002],[-0.6610609999999997,-1.4334060000000002],[-0.7110609999999999,-1.4334060000000002],[-0.7610609999999998,-1.4334060000000002],[-0.8110609999999996,-1.4334060000000002],[-0.8610609999999999,-1.3834060000000001],[-0.9110609999999997,-1.3834060000000001],[-0.9610609999999997,-1.3834060000000001],[-1.0110609999999998,-1.4334060000000002],[-1.0610609999999998,-1.4334060000000002],[-1.1110609999999999,-1.4334060000000002],[-1.1610609999999997,-1.4334060000000002],[-1.2110609999999997,-1.4334060000000002],[-1.2610609999999998,-1.4334060000000002],[-1.3110609999999998,-1.4334060000000002],[-1.3610609999999999,-1.4334060000000002],[-1.4110609999999997,-1.4334060000000002],[-1.4610609999999997,-1.4334060000000002],[-1.5110609999999998,-1.3834060000000001],[-1.5610609999999998,-1.4334060000000002],[-1.6110609999999999,-1.4334060000000002],[-1.6610609999999997,-1.4334060000000002],[-1.7110609999999997,-1.4334060000000002],[-1.7610609999999998,-1.483406],[-1.8110609999999998,-1.483406],[-1.8610609999999999,-1.4334060000000002],[-1.9110609999999997,-1.4334060000000002],[-1.961061,-1.4334060000000002],[-2.0110609999999998,-1.4334060000000002],[-2.0610609999999996,-1.4334060000000002],[-2.111061,-1.483406],[-2.1610609999999997,-1.4334060000000002],[-2.1610609999999997,-1.3834060000000001],[-2.211061,-1.333406],[-2.211061,-1.2834060000000003],[-2.2610609999999998,-1.233406],[-2.2610609999999998,-1.1834060000000002],[-2.211061,-1.233406],[-2.1610609999999997,-1.233406],[-2.111061,-1.233406],[-2.0610609999999996,-1.233406],[-2.0110609999999998,-1.1834060000000002],[-2.0110609999999998,-1.1334060000000001],[-2.0110609999999998,-1.083406],[-2.0110609999999998,-1.033406],[-1.961061,-0.983406],[-1.961061,-0.9334060000000002],[-1.961061,-0.8834060000000001],[-2.0110609999999998,-0.8334060000000001],[-2.0610609999999996,-0.8334060000000001],[-2.111061,-0.8334060000000001],[-2.1610609999999997,-0.783406],[-2.211061,-0.733406],[-2.211061,-0.6834060000000002],[-2.211061,-0.6334060000000001],[-2.211061,-0.5834060000000001],[-2.211061,-0.533406],[-2.2610609999999998,-0.483406],[-2.2610609999999998,-0.4334060000000002],[-2.2610609999999998,-0.38340600000000014],[-2.2610609999999998,-0.3334060000000001],[-2.2610609999999998,-0.28340600000000005],[-2.2610609999999998,-0.233406],[-2.2610609999999998,-0.18340600000000018],[-2.2610609999999998,-0.1334059999999999],[-2.2610609999999998,-0.08340600000000009],[-2.2610609999999998,-0.03340600000000027],[-2.2610609999999998,0.016593999999999998],[-2.3110609999999996,0.06659399999999982],[-2.3110609999999996,0.11659400000000009],[-2.2610609999999998,0.11659400000000009],[-2.211061,0.11659400000000009],[-2.2610609999999998,0.06659399999999982],[-2.211061,0.016593999999999998],[-2.1610609999999997,0.016593999999999998],[-2.111061,0.016593999999999998],[-2.0610609999999996,0.06659399999999982],[-2.0110609999999998,0.06659399999999982],[-1.961061,0.06659399999999982],[-1.9110609999999997,0.06659399999999982],[-1.8610609999999999,0.016593999999999998],[-1.8110609999999998,0.06659399999999982],[-1.8110609999999998,0.11659400000000009],[-1.8110609999999998,0.1665939999999999],[-1.8110609999999998,0.21659400000000018],[-1.8110609999999998,0.266594],[-1.8610609999999999,0.3165939999999998],[-1.8610609999999999,0.3665940000000001],[-1.8610609999999999,0.4165939999999999],[-1.8610609999999999,0.4665940000000002],[-1.8610609999999999,0.516594],[-1.8610609999999999,0.5665939999999998],[-1.8610609999999999,0.6165940000000001],[-1.8610609999999999,0.6665939999999999],[-1.8610609999999999,0.7165940000000002],[-1.8610609999999999,0.766594],[-1.9110609999999997,0.8165939999999998],[-1.9110609999999997,0.8665940000000001],[-1.9110609999999997,0.9165939999999999],[-1.9110609999999997,0.9665940000000002],[-1.9110609999999997,1.016594],[-1.9110609999999997,1.0665939999999998],[-1.9110609999999997,1.116594],[-1.961061,1.166594],[-1.961061,1.2165940000000002],[-1.961061,1.266594],[-1.961061,1.3165939999999998],[-2.0110609999999998,1.366594],[-2.0610609999999996,1.366594],[-2.111061,1.366594],[-2.1610609999999997,1.3165939999999998],[-2.1610609999999997,1.366594],[-2.1610609999999997,1.416594],[-2.1610609999999997,1.4665940000000002],[-2.111061,1.516594],[-2.111061,1.5665939999999998],[-2.111061,1.616594],[-2.111061,1.666594],[-2.1610609999999997,1.7165940000000002],[-2.211061,1.766594],[-2.2610609999999998,1.7165940000000002],[-2.3110609999999996,1.7165940000000002],[-2.361061,1.766594],[-2.4110609999999997,1.8165939999999998],[-2.4110609999999997,1.8665939999999996],[-2.361061,1.9165940000000004],[-2.361061,1.9665940000000002],[-2.3110609999999996,2.016594],[-2.361061,2.066594],[-2.361061,2.1165939999999996],[-2.361061,2.1665940000000004],[-2.3110609999999996,2.216594],[-2.361061,2.266594],[-2.361061,2.316594],[-2.361061,2.3665939999999996],[-2.3110609999999996,2.4165940000000004],[-2.2610609999999998,2.4165940000000004],[-2.211061,2.466594],[-2.1610609999999997,2.516594],[-2.111061,2.516594],[-2.0610609999999996,2.516594],[-2.0110609999999998,2.516594],[-1.961061,2.516594],[-1.9110609999999997,2.516594],[-1.8610609999999999,2.516594],[-1.8110609999999998,2.516594],[-1.7610609999999998,2.466594],[-1.7610609999999998,2.4165940000000004],[-1.7610609999999998,2.3665939999999996],[-1.7610609999999998,2.316594],[-1.8110609999999998,2.266594],[-1.8110609999999998,2.216594],[-1.7610609999999998,2.1665940000000004],[-1.7110609999999997,2.1665940000000004],[-1.6610609999999997,2.1665940000000004],[-1.6110609999999999,2.1665940000000004],[-1.5610609999999998,2.1665940000000004],[-1.5110609999999998,2.1665940000000004],[-1.4610609999999997,2.1665940000000004],[-1.4110609999999997,2.1665940000000004],[-1.3610609999999999,2.1165939999999996],[-1.3110609999999998,2.1165939999999996],[-1.3110609999999998,2.066594],[-1.3610609999999999,2.016594],[-1.3610609999999999,1.9665940000000002],[-1.3110609999999998,1.9165940000000004],[-1.3110609999999998,1.8665939999999996],[-1.2610609999999998,1.8165939999999998],[-1.2110609999999997,1.8165939999999998],[-1.1610609999999997,1.766594],[-1.1110609999999999,1.766594],[-1.0610609999999998,1.8165939999999998],[-1.0610609999999998,1.8665939999999996],[-1.0110609999999998,1.8665939999999996],[-0.9610609999999997,1.9165940000000004],[-0.9610609999999997,1.9665940000000002],[-0.9610609999999997,2.016594],[-0.9610609999999997,2.066594],[-0.9110609999999997,2.066594],[-0.8610609999999999,2.1165939999999996],[-0.8110609999999996,2.1665940000000004],[-0.8610609999999999,2.216594],[-0.9110609999999997,2.216594],[-0.9110609999999997,2.266594],[-0.9110609999999997,2.316594],[-0.9110609999999997,2.3665939999999996],[-0.9110609999999997,2.4165940000000004],[-0.9110609999999997,2.466594],[-0.8610609999999999,2.516594],[-0.8110609999999996,2.516594],[-0.7610609999999998,2.516594],[-0.7110609999999999,2.516594],[-0.6610609999999997,2.516594],[-0.6110609999999999,2.516594],[-0.5610609999999996,2.516594],[-0.5110609999999998,2.516594],[-0.4610609999999995,2.516594],[-0.4110609999999997,2.516594],[-0.36106099999999985,2.516594],[-0.3110609999999996,2.516594],[-0.26106099999999977,2.516594],[-0.2110609999999995,2.516594],[-0.16106099999999968,2.516594],[-0.11106099999999985,2.516594],[-0.06106099999999959,2.516594],[-0.06106099999999959,2.466594],[-0.011060999999999765,2.4165940000000004],[-0.011060999999999765,2.3665939999999996],[-0.011060999999999765,2.316594],[-0.06106099999999959,2.266594],[-0.11106099999999985,2.216594],[-0.11106099999999985,2.1665940000000004],[-0.16106099999999968,2.1665940000000004],[-0.2110609999999995,2.1165939999999996],[-0.16106099999999968,2.066594],[-0.16106099999999968,2.016594],[-0.2110609999999995,1.9665940000000002],[-0.16106099999999968,1.9165940000000004],[-0.11106099999999985,1.8665939999999996],[-0.06106099999999959,1.8165939999999998],[-0.011060999999999765,1.8165939999999998],[0.0389390000000005,1.8665939999999996],[0.08893900000000032,1.8665939999999996],[0.13893900000000015,1.9165940000000004],[0.13893900000000015,1.9665940000000002],[0.13893900000000015,2.016594],[0.13893900000000015,2.066594],[0.08893900000000032,2.1165939999999996],[0.13893900000000015,2.1165939999999996],[0.1889390000000004,2.1165939999999996],[0.23893900000000023,2.1165939999999996],[0.2889390000000005,2.1165939999999996],[0.3389390000000003,2.1165939999999996],[0.38893900000000015,2.1165939999999996],[0.4389390000000004,2.1165939999999996],[0.48893900000000023,2.1165939999999996],[0.5389390000000005,2.066594],[0.5889390000000003,2.066594],[0.6389390000000001,2.066594],[0.6889390000000004,2.066594],[0.7389390000000002,2.066594],[0.7889390000000005,2.066594],[0.8389390000000003,2.066594],[0.8889390000000001,2.1165939999999996],[0.9389390000000004,2.1165939999999996],[0.9889390000000002,2.1665940000000004],[0.9389390000000004,2.216594],[0.8889390000000001,2.216594],[0.8889390000000001,2.266594],[0.9389390000000004,2.316594],[0.8889390000000001,2.3665939999999996],[0.8889390000000001,2.4165940000000004],[0.8889390000000001,2.466594],[0.8889390000000001,2.516594],[0.9389390000000004,2.566594],[0.9889390000000002,2.566594],[1.0389390000000005,2.566594],[1.0889390000000003,2.566594],[1.1389390000000001,2.566594],[1.188939,2.566594],[1.2389390000000007,2.566594],[1.2889390000000005,2.566594],[1.3389390000000003,2.566594],[1.3889390000000001,2.566594],[1.438939,2.566594],[1.4889390000000007,2.566594],[1.5389390000000005,2.566594],[1.5889390000000003,2.566594],[1.6389390000000001,2.566594],[1.688939,2.566594],[1.7389390000000007,2.6165940000000005],[1.7889390000000005,2.6165940000000005],[1.8389390000000003,2.6165940000000005],[1.8889390000000001,2.6165940000000005],[1.9389390000000009,2.6165940000000005],[1.9889390000000007,2.6165940000000005],[2.0389390000000005,2.6165940000000005],[2.0889390000000003,2.566594],[2.138939,2.566594],[2.188939000000001,2.566594],[2.2389390000000007,2.566594],[2.2889390000000005,2.566594],[2.3389390000000003,2.566594],[2.388939,2.516594],[2.388939,2.466594],[2.388939,2.4165940000000004],[2.3389390000000003,2.3665939999999996],[2.3389390000000003,2.316594],[2.3389390000000003,2.266594],[2.388939,2.216594],[2.438939000000001,2.1665940000000004],[2.4889390000000007,2.1165939999999996],[2.4889390000000007,2.066594],[2.4889390000000007,2.016594],[2.4889390000000007,1.9665940000000002],[2.5389390000000005,1.9165940000000004],[2.5389390000000005,1.8665939999999996],[2.5389390000000005,1.8165939999999998],[2.5389390000000005,1.766594],[2.5389390000000005,1.7165940000000002],[2.5389390000000005,1.666594],[2.5889390000000003,1.616594],[2.638939,1.5665939999999998],[2.638939,1.516594],[2.688939000000001,1.4665940000000002],[2.688939000000001,1.416594],[2.688939000000001,1.366594],[2.638939,1.3165939999999998],[2.5889390000000003,1.3165939999999998],[2.5889390000000003,1.366594],[2.5889390000000003,1.416594],[2.5889390000000003,1.4665940000000002],[2.5389390000000005,1.516594],[2.4889390000000007,1.5665939999999998],[2.438939000000001,1.5665939999999998],[2.388939,1.516594],[2.388939,1.4665940000000002],[2.388939,1.416594],[2.388939,1.366594],[2.388939,1.3165939999999998],[2.438939000000001,1.266594],[2.438939000000001,1.2165940000000002],[2.388939,1.266594],[2.3389390000000003,1.3165939999999998],[2.2889390000000005,1.266594],[2.2889390000000005,1.2165940000000002],[2.2889390000000005,1.166594],[2.2889390000000005,1.116594],[2.3389390000000003,1.0665939999999998],[2.3389390000000003,1.016594],[2.3389390000000003,0.9665940000000002],[2.3389390000000003,0.9165939999999999],[2.388939,0.8665940000000001],[2.388939,0.8165939999999998],[2.388939,0.766594],[2.388939,0.7165940000000002],[2.388939,0.6665939999999999],[2.438939000000001,0.6165940000000001],[2.438939000000001,0.5665939999999998],[2.438939000000001,0.516594],[2.4889390000000007,0.4665940000000002],[2.4889390000000007,0.4165939999999999],[2.4889390000000007,0.3665940000000001],[2.5389390000000005,0.3165939999999998],[2.5389390000000005,0.266594],[2.5389390000000005,0.21659400000000018],[2.5389390000000005,0.1665939999999999],[2.5389390000000005,0.11659400000000009],[2.5889390000000003,0.06659399999999982],[2.638939,0.06659399999999982],[2.688939000000001,0.11659400000000009],[2.688939000000001,0.1665939999999999],[2.688939000000001,0.21659400000000018],[2.688939000000001,0.266594],[2.7389390000000007,0.266594],[2.7889390000000005,0.266594],[2.8389390000000003,0.266594],[2.888939,0.266594],[2.938939000000001,0.266594],[2.9889390000000007,0.266594],[3.0389390000000005,0.21659400000000018],[3.0389390000000005,0.1665939999999999],[3.0389390000000005,0.11659400000000009],[3.0389390000000005,0.06659399999999982],[3.0389390000000005,0.016593999999999998],[3.0389390000000005,-0.03340600000000027],[3.0889390000000003,-0.08340600000000009],[3.0889390000000003,-0.1334059999999999],[3.0889390000000003,-0.18340600000000018],[3.0889390000000003,-0.233406],[3.138939,-0.28340600000000005],[3.138939,-0.3334060000000001],[3.138939,-0.38340600000000014],[3.138939,-0.4334060000000002],[3.138939,-0.483406],[3.0889390000000003,-0.533406],[3.0889390000000003,-0.5834060000000001],[3.138939,-0.6334060000000001],[3.188939000000001,-0.6334060000000001],[3.188939000000001,-0.6834060000000002],[3.188939000000001,-0.733406],[3.188939000000001,-0.783406],[3.2389390000000007,-0.8334060000000001],[3.188939000000001,-0.8834060000000001],[3.138939,-0.9334060000000002],[3.138939,-0.983406],[3.138939,-1.033406],[3.138939,-1.083406],[3.138939,-1.1334060000000001],[3.0889390000000003,-1.1834060000000002],[3.0389390000000005,-1.1834060000000002],[2.9889390000000007,-1.1834060000000002],[2.938939000000001,-1.1834060000000002],[2.888939,-1.1834060000000002],[2.8389390000000003,-1.1834060000000002],[2.7889390000000005,-1.1834060000000002],[2.7389390000000007,-1.1834060000000002],[2.688939000000001,-1.1834060000000002],[2.638939,-1.1834060000000002],[2.5889390000000003,-1.233406],[2.5389390000000005,-1.233406],[2.4889390000000007,-1.2834060000000003],[2.438939000000001,-1.233406],[2.388939,-1.233406],[2.3389390000000003,-1.233406],[2.2889390000000005,-1.233406],[2.2389390000000007,-1.1834060000000002],[2.2389390000000007,-1.1334060000000001],[2.2389390000000007,-1.083406],[2.188939000000001,-1.033406],[2.188939000000001,-0.983406],[2.188939000000001,-0.9334060000000002],[2.2389390000000007,-0.8834060000000001],[2.2389390000000007,-0.8334060000000001],[2.188939000000001,-0.783406],[2.138939,-0.783406],[2.0889390000000003,-0.783406],[2.0389390000000005,-0.783406],[1.9889390000000007,-0.783406],[1.9389390000000009,-0.783406],[1.8889390000000001,-0.8334060000000001],[1.8389390000000003,-0.8334060000000001],[1.7889390000000005,-0.8334060000000001],[1.7389390000000007,-0.8834060000000001],[1.7889390000000005,-0.9334060000000002],[1.8389390000000003,-0.983406],[1.8389390000000003,-1.033406],[1.8389390000000003,-1.083406],[1.8389390000000003,-1.1334060000000001],[1.7889390000000005,-1.1834060000000002],[1.7389390000000007,-1.233406],[1.688939,-1.233406],[1.6389390000000001,-1.233406],[1.5889390000000003,-1.233406],[1.5389390000000005,-1.233406],[1.4889390000000007,-1.2834060000000003],[1.438939,-1.2834060000000003],[1.3889390000000001,-1.2834060000000003],[1.3389390000000003,-1.2834060000000003],[1.2889390000000005,-1.2834060000000003],[1.2389390000000007,-1.2834060000000003],[1.188939,-1.2834060000000003],[1.1389390000000001,-1.2834060000000003],[1.0889390000000003,-1.2834060000000003],[1.0389390000000005,-1.2834060000000003],[0.9889390000000002,-1.2834060000000003],[0.9389390000000004,-1.2834060000000003],[0.8889390000000001,-1.2834060000000003],[0.8389390000000003,-1.2834060000000003],[0.8389390000000003,-1.233406],[0.8389390000000003,-1.1834060000000002],[0.8389390000000003,-1.1334060000000001],[0.8389390000000003,-1.083406],[0.8389390000000003,-1.033406],[0.8889390000000001,-0.983406],[0.8889390000000001,-0.9334060000000002],[0.8389390000000003,-0.8834060000000001],[0.7889390000000005,-0.8834060000000001],[0.7389390000000002,-0.8834060000000001],[0.6889390000000004,-0.8834060000000001],[0.6389390000000001,-0.9334060000000002],[0.5889390000000003,-0.9334060000000002],[0.5389390000000005,-0.9334060000000002],[0.48893900000000023,-0.9334060000000002],[0.4389390000000004,-0.8834060000000001],[0.4389390000000004,-0.8334060000000001],[0.4389390000000004,-0.783406],[0.38893900000000015,-0.733406],[0.38893900000000015,-0.6834060000000002],[0.3389390000000003,-0.6334060000000001],[0.3389390000000003,-0.5834060000000001],[0.2889390000000005,-0.533406],[0.23893900000000023,-0.533406],[0.1889390000000004,-0.5834060000000001],[0.13893900000000015,-0.5834060000000001],[0.08893900000000032,-0.6334060000000001]])
C1 = reccalib.Circle(center=np.array([-0.9, 0.9]), radius=0.3)
C2 = reccalib.Circle(center=np.array([1.2, 0.5]), radius=0.4)
q1 = np.array([0.2, 0.6, 0.0])
q2 = np.array([-1.35, -0.86, 0.71])
NOISE = 0.01


def ray_polygon_intersect(poly, origin, direction):
    A, B = poly[:-1], poly[1:]
    AB = B - A
    AO = A - origin
    D = direction
    denom = D[0]*AB[:,1] - D[1]*AB[:,0]
    mask = np.abs(denom) > 1e-8
    t = (AO[:,0]*AB[:,1] - AO[:,1]*AB[:,0])[mask] / denom[mask]
    u = (AO[:,0]*D[1] - AO[:,1]*D[0])[mask] / denom[mask]
    valid = (t > 0) & (u >= 0) & (u <= 1)
    return origin + t[valid].min() * D if np.any(valid) else None

def simulate_lidar_snapshot(p: np.ndarray, poly: np.ndarray, c1: reccalib.Circle, c2: reccalib.Circle):
    points = []
    for i in range(720):
        theta = i * np.pi / 360
        direction = np.array([np.cos(theta), np.sin(theta)])
        isect_poly = ray_polygon_intersect(poly, p[:2], direction) # assume it's never None!
        isect_c1 = ray_polygon_intersect(c1.representing_polygon(), p[:2], direction)
        isect_c2 = ray_polygon_intersect(c2.representing_polygon(), p[:2], direction)
        # append the closest intersection point
        tmp = [isect_poly, isect_c1, isect_c2]
        tmp = [x for x in tmp if x is not None]
        if len(tmp) == 0:
            continue
        closest = min(tmp, key=lambda x: np.linalg.norm(x - p[:2]))
        closest += np.random.normal(0, NOISE, 2)  # Add noise

        # Rotate the cloud accordingly
        closest -= p[:2]
        closest = np.array([
            closest[0] * np.cos(p[2]) - closest[1] * np.sin(p[2]),
            closest[0] * np.sin(p[2]) + closest[1] * np.cos(p[2])
        ])

        points.append(closest)
    return np.array(points)

def test_reccalib_fit_circle_least_squares():
    success = 0
    num_experiences = 10000
    for _ in range(num_experiences):
        # Test the circle fitting function with a few example points
        #sample N = 100 points on a circle
        theta1 = np.random.uniform(0, 2 * np.pi)
        theta2 = np.random.uniform(theta1 + 30 / 180 * np.pi, 2 * np.pi) # At least 10 degrees apart
        Cx, Cy, Cr = np.random.uniform(-0.5, 0.5, 3)
        Cr = 0.5 * (Cr + 1)
        thetas = np.linspace(theta1, theta2, 100)
        points = np.zeros((len(thetas), 2))
        points[:, 0] = Cr * np.cos(thetas) + Cx
        points[:, 1] = Cr * np.sin(thetas) + Cy
        points += np.random.normal(0, 0.0005, points.shape)

        # Fit the circle using the least squares method
        ls = reccalib.LidarSnapshot(points=points, device_id="test_device", timestamp=0)
        circle = reccalib.fit_circle_least_squares(ls)

        Corg = np.array([Cx, Cy, Cr])
        Cfit = np.array([circle.center[0], circle.center[1], circle.radius])
        err = np.linalg.norm(Corg - Cfit)
        success += 1 if err < 0.01 else 0
    assert success > 0.95 * num_experiences, f"Failed to fit circle in {success} out of {num_experiences} attempts."



if __name__ == "__main__":
    reccalib.symb_lagrangian()

    lidar_q1 = simulate_lidar_snapshot(q1, LAB_POLYGON, C1, C2)
    lidar_q2 = simulate_lidar_snapshot(q2, LAB_POLYGON, C1, C2)
    lidars = [lidar_q1, lidar_q2]
    qs = [q1, q2]

    circles = []

    # Draw first q1 lidar
    for lidar, q in zip(lidars, qs):
        # Fit the circles
        ls = reccalib.LidarSnapshot(points=lidar, device_id="test_device", timestamp=0)
        C1_ = reccalib.find_best_circle(ls, C1.radius)
        C2_ = reccalib.find_best_circle(ls, C2.radius)
        circles.append(C1_)
        circles.append(C2_)

        plt.plot(lidar[:,0], lidar[:,1], 'bo', markersize=2, label='Lidar q1')
        plt.plot(q[0], q[1], 'ro', markersize=5, label='q1')
        plt.plot(C1.center[0], C1.center[1], 'go', markersize=5, label='C1 center')
        plt.plot(C2.center[0], C2.center[1], 'mo', markersize=5, label='C2 center')

        # Draw the fitted circles
        circle1 = C1_.representing_polygon()
        circle2 = C2_.representing_polygon()
        plt.plot(circle1[:,0], circle1[:,1], 'g-', label='Fitted C1')
        plt.plot(circle2[:,0], circle2[:,1], 'm-', label='Fitted C2')

    plt.show()
    

    T = np.linalg.inv(reccalib.find_best_transform(*circles))
    print(T)

    # Draw lidar_q1 as is, but lidar_q2 transformed by T
    plt.plot(lidar_q1[:,0], lidar_q1[:,1], 'bo', markersize=2, label='Lidar q1')
    
    # Write the applied transformation yourself
    lidar_q2_transformed = np.dot(lidar_q2, T[:2, :2].T) + T[:2, 2]
    plt.plot(lidar_q2_transformed[:,0], lidar_q2_transformed[:,1], 'ro', markersize=2, label='Transformed Lidar q2')
    plt.show()
